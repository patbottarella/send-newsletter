"use strict";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const fs = require('fs');

const path = require('path');

const I18N = require('@ladjs/i18n');

const _ = require('lodash');

const autoBind = require('auto-bind');

const consolidate = require('consolidate');

const debug = require('debug')('email-templates');

const getPaths = require('get-paths');

const htmlToText = require('html-to-text');

const is = require('@sindresorhus/is');

const juice = require('juice');

const nodemailer = require('nodemailer');

const pify = require('pify');

const previewEmail = require('preview-email'); // promise version of `juice.juiceResources`


const juiceResources = (html, options) => {
  return new Promise((resolve, reject) => {
    juice.juiceResources(html, options, (err, html) => {
      if (err) return reject(err);
      resolve(html);
    });
  });
};

const env = (process.env.NODE_ENV || 'development').toLowerCase();
const stat = pify(fs.stat);
const readFile = pify(fs.readFile);

class Email {
  constructor(config = {}) {
    debug('config passed %O', config); // 2.x backwards compatible support

    if (config.juiceOptions) {
      config.juiceResources = config.juiceOptions;
      delete config.juiceOptions;
    }

    if (config.disableJuice) {
      config.juice = false;
      delete config.disableJuice;
    }

    if (config.render) {
      config.customRender = true;
    }

    this.config = _.merge({
      views: {
        // directory where email templates reside
        root: path.resolve('emails'),
        options: {
          // default file extension for template
          extension: 'pug',
          map: {
            hbs: 'handlebars',
            njk: 'nunjucks'
          },
          engineSource: consolidate
        },
        // locals to pass to templates for rendering
        locals: {
          // turn on caching for non-development environments
          cache: !['development', 'test'].includes(env),
          // pretty is automatically set to `false` for subject/text
          pretty: true
        }
      },
      // <https://nodemailer.com/message/>
      message: {},
      send: !['development', 'test'].includes(env),
      preview: env === 'development',
      // <https://github.com/ladjs/i18n>
      // set to an object to configure and enable it
      i18n: false,
      // pass a custom render function if necessary
      render: this.render.bind(this),
      customRender: false,
      // force text-only rendering of template (disregards template folder)
      textOnly: false,
      // <https://github.com/werk85/node-html-to-text>
      htmlToText: {
        ignoreImage: true
      },
      subjectPrefix: false,
      // <https://github.com/Automattic/juice>
      juice: true,
      juiceResources: {
        preserveImportant: true,
        webResources: {
          relativeTo: path.resolve('build'),
          images: false
        }
      },
      // pass a transport configuration object or a transport instance
      // (e.g. an instance is created via `nodemailer.createTransport`)
      // <https://nodemailer.com/transports/>
      transport: {},
      // last locale field name (also used by @ladjs/i18n)
      lastLocaleField: 'last_locale'
    }, config); // override existing method

    this.render = this.config.render;
    if (!_.isFunction(this.config.transport.sendMail)) this.config.transport = nodemailer.createTransport(this.config.transport);
    debug('transformed config %O', this.config);
    autoBind(this);
  } // shorthand use of `juiceResources` with the config
  // (mainly for custom renders like from a database)


  juiceResources(html) {
    return juiceResources(html, this.config.juiceResources);
  } // a simple helper function that gets the actual file path for the template


  async getTemplatePath(template) {
    const [root, view] = path.isAbsolute(template) ? [path.dirname(template), path.basename(template)] : [this.config.views.root, template];
    const paths = await getPaths(root, view, this.config.views.options.extension);
    const filePath = path.resolve(root, paths.rel);
    return {
      filePath,
      paths
    };
  } // returns true or false if a template exists
  // (uses same look-up approach as `render` function)


  async templateExists(view) {
    try {
      const {
        filePath
      } = await this.getTemplatePath(view);
      const stats = await stat(filePath);
      if (!stats.isFile()) throw new Error(`${filePath} was not a file`);
      return true;
    } catch (err) {
      debug('templateExists', err);
      return false;
    }
  }

  async checkAndRender(type, template, locals) {
    const str = `${template}/${type}`;

    if (!this.config.customRender) {
      const exists = await this.templateExists(str);
      if (!exists) return;
    }

    return this.render(str, _objectSpread({}, locals, {}, type === 'html' ? {} : {
      pretty: false
    }));
  } // promise version of consolidate's render
  // inspired by koa-views and re-uses the same config
  // <https://github.com/queckezz/koa-views>


  async render(view, locals = {}) {
    const {
      map,
      engineSource
    } = this.config.views.options;
    const {
      filePath,
      paths
    } = await this.getTemplatePath(view);

    if (paths.ext === 'html' && !map) {
      const res = await readFile(filePath, 'utf8');
      return res;
    }

    const engineName = map && map[paths.ext] ? map[paths.ext] : paths.ext;
    const renderFn = engineSource[engineName];
    if (!engineName || !renderFn) throw new Error(`Engine not found for the ".${paths.ext}" file extension`);

    if (_.isObject(this.config.i18n)) {
      if (this.config.i18n.lastLocaleField && this.config.lastLocaleField && this.config.i18n.lastLocaleField !== this.config.lastLocaleField) throw new Error(`The 'lastLocaleField' (String) option for @ladjs/i18n and email-templates do not match, i18n value was ${this.config.i18n.lastLocaleField} and email-templates value was ${this.config.lastLocaleField}`);
      const i18n = new I18N(_objectSpread({}, this.config.i18n, {
        register: locals
      })); // support `locals.user.last_locale` (variable based name lastLocaleField)
      // (e.g. for <https://lad.js.org>)

      if (_.isObject(locals.user) && _.isString(locals.user[this.config.lastLocaleField])) locals.locale = locals.user[this.config.lastLocaleField];
      if (_.isString(locals.locale)) i18n.setLocale(locals.locale);
    }

    const res = await pify(renderFn)(filePath, locals); // transform the html with juice using remote paths
    // google now supports media queries
    // https://developers.google.com/gmail/design/reference/supported_css

    if (!this.config.juice) return res;
    const html = await this.juiceResources(res);
    return html;
  }

  async renderAll(template, locals = {}, nodemailerMessage = {}) {
    const message = _objectSpread({}, nodemailerMessage);

    if (template) {
      const [subject, html, text] = await Promise.all(['subject', 'html', 'text'].map(type => this.checkAndRender(type, template, locals)));
      if (subject) message.subject = subject.trim();
      if (html) message.html = html;
      if (text) message.text = text;
    }

    if (message.subject && this.config.subjectPrefix) message.subject = this.config.subjectPrefix + message.subject;
    if (this.config.htmlToText && message.html && !message.text) // we'd use nodemailer-html-to-text plugin
      // but we really don't need to support cid
      // <https://github.com/andris9/nodemailer-html-to-text>
      message.text = htmlToText.fromString(message.html, this.config.htmlToText); // if we only want a text-based version of the email

    if (this.config.textOnly) delete message.html; // if no subject, html, or text content exists then we should
    // throw an error that says at least one must be found
    // otherwise the email would be blank (defeats purpose of email-templates)

    if ((!is.string(message.subject) || is.emptyStringOrWhitespace(message.subject)) && (!is.string(message.text) || is.emptyStringOrWhitespace(message.text)) && (!is.string(message.html) || is.emptyStringOrWhitespace(message.html)) && _.isArray(message.attachments) && _.isEmpty(message.attachments)) throw new Error(`No content was passed for subject, html, text, nor attachments message props. Check that the files for the template "${template}" exist.`);
    return message;
  }

  async send(options = {}) {
    options = _objectSpread({
      template: '',
      message: {},
      locals: {}
    }, options);
    let {
      template,
      message,
      locals
    } = options;
    const attachments = message.attachments || this.config.message.attachments || [];
    message = _.defaultsDeep({}, _.omit(message, 'attachments'), _.omit(this.config.message, 'attachments'));
    locals = _.defaultsDeep({}, this.config.views.locals, locals);
    if (attachments) message.attachments = attachments;
    debug('template %s', template);
    debug('message %O', message);
    debug('locals (keys only): %O', Object.keys(locals)); // get all available templates

    const obj = await this.renderAll(template, locals, message); // assign the object variables over to the message

    Object.assign(message, obj);

    if (this.config.preview) {
      debug('using `preview-email` to preview email');
      if (_.isObject(this.config.preview)) await previewEmail(message, this.config.preview);else await previewEmail(message);
    }

    if (!this.config.send) {
      debug('send disabled so we are ensuring JSONTransport'); // <https://github.com/nodemailer/nodemailer/issues/798>
      // if (this.config.transport.name !== 'JSONTransport')

      this.config.transport = nodemailer.createTransport({
        jsonTransport: true
      });
    }

    const res = await this.config.transport.sendMail(message);
    debug('message sent');
    res.originalMessage = message;
    return res;
  }

}

module.exports = Email;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwiSTE4TiIsIl8iLCJhdXRvQmluZCIsImNvbnNvbGlkYXRlIiwiZGVidWciLCJnZXRQYXRocyIsImh0bWxUb1RleHQiLCJpcyIsImp1aWNlIiwibm9kZW1haWxlciIsInBpZnkiLCJwcmV2aWV3RW1haWwiLCJqdWljZVJlc291cmNlcyIsImh0bWwiLCJvcHRpb25zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJlbnYiLCJwcm9jZXNzIiwiTk9ERV9FTlYiLCJ0b0xvd2VyQ2FzZSIsInN0YXQiLCJyZWFkRmlsZSIsIkVtYWlsIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJqdWljZU9wdGlvbnMiLCJkaXNhYmxlSnVpY2UiLCJyZW5kZXIiLCJjdXN0b21SZW5kZXIiLCJtZXJnZSIsInZpZXdzIiwicm9vdCIsImV4dGVuc2lvbiIsIm1hcCIsImhicyIsIm5qayIsImVuZ2luZVNvdXJjZSIsImxvY2FscyIsImNhY2hlIiwiaW5jbHVkZXMiLCJwcmV0dHkiLCJtZXNzYWdlIiwic2VuZCIsInByZXZpZXciLCJpMThuIiwiYmluZCIsInRleHRPbmx5IiwiaWdub3JlSW1hZ2UiLCJzdWJqZWN0UHJlZml4IiwicHJlc2VydmVJbXBvcnRhbnQiLCJ3ZWJSZXNvdXJjZXMiLCJyZWxhdGl2ZVRvIiwiaW1hZ2VzIiwidHJhbnNwb3J0IiwibGFzdExvY2FsZUZpZWxkIiwiaXNGdW5jdGlvbiIsInNlbmRNYWlsIiwiY3JlYXRlVHJhbnNwb3J0IiwiZ2V0VGVtcGxhdGVQYXRoIiwidGVtcGxhdGUiLCJ2aWV3IiwiaXNBYnNvbHV0ZSIsImRpcm5hbWUiLCJiYXNlbmFtZSIsInBhdGhzIiwiZmlsZVBhdGgiLCJyZWwiLCJ0ZW1wbGF0ZUV4aXN0cyIsInN0YXRzIiwiaXNGaWxlIiwiRXJyb3IiLCJjaGVja0FuZFJlbmRlciIsInR5cGUiLCJzdHIiLCJleGlzdHMiLCJleHQiLCJyZXMiLCJlbmdpbmVOYW1lIiwicmVuZGVyRm4iLCJpc09iamVjdCIsInJlZ2lzdGVyIiwidXNlciIsImlzU3RyaW5nIiwibG9jYWxlIiwic2V0TG9jYWxlIiwicmVuZGVyQWxsIiwibm9kZW1haWxlck1lc3NhZ2UiLCJzdWJqZWN0IiwidGV4dCIsImFsbCIsInRyaW0iLCJmcm9tU3RyaW5nIiwic3RyaW5nIiwiZW1wdHlTdHJpbmdPcldoaXRlc3BhY2UiLCJpc0FycmF5IiwiYXR0YWNobWVudHMiLCJpc0VtcHR5IiwiZGVmYXVsdHNEZWVwIiwib21pdCIsIk9iamVjdCIsImtleXMiLCJvYmoiLCJhc3NpZ24iLCJqc29uVHJhbnNwb3J0Iiwib3JpZ2luYWxNZXNzYWdlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsYUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxDQUFDLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUNBLE1BQU1JLFFBQVEsR0FBR0osT0FBTyxDQUFDLFdBQUQsQ0FBeEI7O0FBQ0EsTUFBTUssV0FBVyxHQUFHTCxPQUFPLENBQUMsYUFBRCxDQUEzQjs7QUFDQSxNQUFNTSxLQUFLLEdBQUdOLE9BQU8sQ0FBQyxPQUFELENBQVAsQ0FBaUIsaUJBQWpCLENBQWQ7O0FBQ0EsTUFBTU8sUUFBUSxHQUFHUCxPQUFPLENBQUMsV0FBRCxDQUF4Qjs7QUFDQSxNQUFNUSxVQUFVLEdBQUdSLE9BQU8sQ0FBQyxjQUFELENBQTFCOztBQUNBLE1BQU1TLEVBQUUsR0FBR1QsT0FBTyxDQUFDLGtCQUFELENBQWxCOztBQUNBLE1BQU1VLEtBQUssR0FBR1YsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTVcsVUFBVSxHQUFHWCxPQUFPLENBQUMsWUFB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cXVpcmUoJ2ZzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgSTE4TiA9IHJlcXVpcmUoJ0BsYWRqcy9pMThuJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBhdXRvQmluZCA9IHJlcXVpcmUoJ2F1dG8tYmluZCcpO1xuY29uc3QgY29uc29saWRhdGUgPSByZXF1aXJlKCdjb25zb2xpZGF0ZScpO1xuY29uc3QgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpKCdlbWFpbC10ZW1wbGF0ZXMnKTtcbmNvbnN0IGdldFBhdGhzID0gcmVxdWlyZSgnZ2V0LXBhdGhzJyk7XG5jb25zdCBodG1sVG9UZXh0ID0gcmVxdWlyZSgnaHRtbC10by10ZXh0Jyk7XG5jb25zdCBpcyA9IHJlcXVpcmUoJ0BzaW5kcmVzb3JodXMvaXMnKTtcbmNvbnN0IGp1aWNlID0gcmVxdWlyZSgnanVpY2UnKTtcbmNvbnN0IG5vZGVtYWlsZXIgPSByZXF1aXJlKCdub2RlbWFpbGVyJyk7XG5jb25zdCBwaWZ5ID0gcmVxdWlyZSgncGlmeScpO1xuY29uc3QgcHJldmlld0VtYWlsID0gcmVxdWlyZSgncHJldmlldy1lbWFpbCcpO1xuXG4vLyBwcm9taXNlIHZlcnNpb24gb2YgYGp1aWNlLmp1aWNlUmVzb3VyY2VzYFxuY29uc3QganVpY2VSZXNvdXJjZXMgPSAoaHRtbCwgb3B0aW9ucykgPT4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGp1aWNlLmp1aWNlUmVzb3VyY2VzKGh0bWwsIG9wdGlvbnMsIChlcnIsIGh0bWwpID0+IHtcbiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgIHJlc29sdmUoaHRtbCk7XG4gICAgfSk7XG4gIH0pO1xufTtcblxuY29uc3QgZW52ID0gKHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8ICdkZXZlbG9wbWVudCcpLnRvTG93ZXJDYXNlKCk7XG5jb25zdCBzdGF0ID0gcGlmeShmcy5zdGF0KTtcbmNvbnN0IHJlYWRGaWxlID0gcGlmeShmcy5yZWFkRmlsZSk7XG5cbmNsYXNzIEVtYWlsIHtcbiAgY29uc3RydWN0b3IoY29uZmlnID0ge30pIHtcbiAgICBkZWJ1ZygnY29uZmlnIHBhc3NlZCAlTycsIGNvbmZpZyk7XG5cbiAgICAvLyAyLnggYmFja3dhcmRzIGNvbXBhdGlibGUgc3VwcG9ydFxuICAgIGlmIChjb25maWcuanVpY2VPcHRpb25zKSB7XG4gICAgICBjb25maWcuanVpY2VSZXNvdXJjZXMgPSBjb25maWcuanVpY2VPcHRpb25zO1xuICAgICAgZGVsZXRlIGNvbmZpZy5qdWljZU9wdGlvbnM7XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5kaXNhYmxlSnVpY2UpIHtcbiAgICAgIGNvbmZpZy5qdWljZSA9IGZhbHNlO1xuICAgICAgZGVsZXRlIGNvbmZpZy5kaXNhYmxlSnVpY2U7XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5yZW5kZXIpIHtcbiAgICAgIGNvbmZpZy5jdXN0b21SZW5kZXIgPSB0cnVlO1xuICAgIH1cblxuICAgIHRoaXMuY29uZmlnID0gXy5tZXJnZShcbiAgICAgIHtcbiAgICAgICAgdmlld3M6IHtcbiAgICAgICAgICAvLyBkaXJlY3Rvcnkgd2hlcmUgZW1haWwgdGVtcGxhdGVzIHJlc2lkZVxuICAgICAgICAgIHJvb3Q6IHBhdGgucmVzb2x2ZSgnZW1haWxzJyksXG4gICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgLy8gZGVmYXVsdCBmaWxlIGV4dGVuc2lvbiBmb3IgdGVtcGxhdGVcbiAgICAgICAgICAgIGV4dGVuc2lvbjogJ3B1ZycsXG4gICAgICAgICAgICBtYXA6IHtcbiAgICAgICAgICAgICAgaGJzOiAnaGFuZGxlYmFycycsXG4gICAgICAgICAgICAgIG5qazogJ251bmp1Y2tzJ1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVuZ2luZVNvdXJjZTogY29uc29saWRhdGVcbiAgICAgICAgICB9LFxuICAgICAgICAgIC8vIGxvY2FscyB0byBwYXNzIHRvIHRlbXBsYXRlcyBmb3IgcmVuZGVyaW5nXG4gICAgICAgICAgbG9jYWxzOiB7XG4gICAgICAgICAgICAvLyB0dXJuIG9uIGNhY2hpbmcgZm9yIG5vbi1kZXZlbG9wbWVudCBlbnZpcm9ubWVudHNcbiAgICAgICAgICAgIGNhY2hlOiAhWydkZXZlbG9wbWVudCcsICd0ZXN0J10uaW5jbHVkZXMoZW52KSxcbiAgICAgICAgICAgIC8vIHByZXR0eSBpcyBhdXRvbWF0aWNhbGx5IHNldCB0byBgZmFsc2VgIGZvciBzdWJqZWN0L3RleHRcbiAgICAgICAgICAgIHByZXR0eTogdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgLy8gPGh0dHBzOi8vbm9kZW1haWxlci5jb20vbWVzc2FnZS8+XG4gICAgICAgIG1lc3NhZ2U6IHt9LFxuICAgICAgICBzZW5kOiAhWydkZXZlbG9wbWVudCcsICd0ZXN0J10uaW5jbHVkZXMoZW52KSxcbiAgICAgICAgcHJldmlldzogZW52ID09PSAnZGV2ZWxvcG1lbnQnLFxuICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL2xhZGpzL2kxOG4+XG4gICAgICAgIC8vIHNldCB0byBhbiBvYmplY3QgdG8gY29uZmlndXJlIGFuZCBlbmFibGUgaXRcbiAgICAgICAgaTE4bjogZmFsc2UsXG4gICAgICAgIC8vIHBhc3MgYSBjdXN0b20gcmVuZGVyIGZ1bmN0aW9uIGlmIG5lY2Vzc2FyeVxuICAgICAgICByZW5kZXI6IHRoaXMucmVuZGVyLmJpbmQodGhpcyksXG4gICAgICAgIGN1c3RvbVJlbmRlcjogZmFsc2UsXG4gICAgICAgIC8vIGZvcmNlIHRleHQtb25seSByZW5kZXJpbmcgb2YgdGVtcGxhdGUgKGRpc3JlZ2FyZHMgdGVtcGxhdGUgZm9sZGVyKVxuICAgICAgICB0ZXh0T25seTogZmFsc2UsXG4gICAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vd2Vyazg1L25vZGUtaHRtbC10by10ZXh0PlxuICAgICAgICBodG1sVG9UZXh0OiB7XG4gICAgICAgICAgaWdub3JlSW1hZ2U6IHRydWVcbiAgICAgICAgfSxcbiAgICAgICAgc3ViamVjdFByZWZpeDogZmFsc2UsXG4gICAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vQXV0b21hdHRpYy9qdWljZT5cbiAgICAgICAganVpY2U6IHRydWUsXG4gICAgICAgIGp1aWNlUmVzb3VyY2VzOiB7XG4gICAgICAgICAgcHJlc2VydmVJbXBvcnRhbnQ6IHRydWUsXG4gICAgICAgICAgd2ViUmVzb3VyY2VzOiB7XG4gICAgICAgICAgICByZWxhdGl2ZVRvOiBwYXRoLnJlc29sdmUoJ2J1aWxkJyksXG4gICAgICAgICAgICBpbWFnZXM6IGZhbHNlXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAvLyBwYXNzIGEgdHJhbnNwb3J0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IG9yIGEgdHJhbnNwb3J0IGluc3RhbmNlXG4gICAgICAgIC8vIChlLmcuIGFuIGluc3RhbmNlIGlzIGNyZWF0ZWQgdmlhIGBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydGApXG4gICAgICAgIC8vIDxodHRwczovL25vZGVtYWlsZXIuY29tL3RyYW5zcG9ydHMvPlxuICAgICAgICB0cmFuc3BvcnQ6IHt9LFxuICAgICAgICAvLyBsYXN0IGxvY2FsZSBmaWVsZCBuYW1lIChhbHNvIHVzZWQgYnkgQGxhZGpzL2kxOG4pXG4gICAgICAgIGxhc3RMb2NhbGVGaWVsZDogJ2xhc3RfbG9jYWxlJ1xuICAgICAgfSxcbiAgICAgIGNvbmZpZ1xuICAgICk7XG5cbiAgICAvLyBvdmVycmlkZSBleGlzdGluZyBtZXRob2RcbiAgICB0aGlzLnJlbmRlciA9IHRoaXMuY29uZmlnLnJlbmRlcjtcblxuICAgIGlmICghXy5pc0Z1bmN0aW9uKHRoaXMuY29uZmlnLnRyYW5zcG9ydC5zZW5kTWFpbCkpXG4gICAgICB0aGlzLmNvbmZpZy50cmFuc3BvcnQgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh0aGlzLmNvbmZpZy50cmFuc3BvcnQpO1xuXG4gICAgZGVidWcoJ3RyYW5zZm9ybWVkIGNvbmZpZyAlTycsIHRoaXMuY29uZmlnKTtcblxuICAgIGF1dG9CaW5kKHRoaXMpO1xuICB9XG5cbiAgLy8gc2hvcnRoYW5kIHVzZSBvZiBganVpY2VSZXNvdXJjZXNgIHdpdGggdGhlIGNvbmZpZ1xuICAvLyAobWFpbmx5IGZvciBjdXN0b20gcmVuZGVycyBsaWtlIGZyb20gYSBkYXRhYmFzZSlcbiAganVpY2VSZXNvdXJjZXMoaHRtbCkge1xuICAgIHJldHVybiBqdWljZVJlc291cmNlcyhodG1sLCB0aGlzLmNvbmZpZy5qdWljZVJlc291cmNlcyk7XG4gIH1cblxuICAvLyBhIHNpbXBsZSBoZWxwZXIgZnVuY3Rpb24gdGhhdCBnZXRzIHRoZSBhY3R1YWwgZmlsZSBwYXRoIGZvciB0aGUgdGVtcGxhdGVcbiAgYXN5bmMgZ2V0VGVtcGxhdGVQYXRoKHRlbXBsYXRlKSB7XG4gICAgY29uc3QgW3Jvb3QsIHZpZXddID0gcGF0aC5pc0Fic29sdXRlKHRlbXBsYXRlKVxuICAgICAgPyBbcGF0aC5kaXJuYW1lKHRlbXBsYXRlKSwgcGF0aC5iYXNlbmFtZSh0ZW1wbGF0ZSldXG4gICAgICA6IFt0aGlzLmNvbmZpZy52aWV3cy5yb290LCB0ZW1wbGF0ZV07XG4gICAgY29uc3QgcGF0aHMgPSBhd2FpdCBnZXRQYXRocyhcbiAgICAgIHJvb3QsXG4gICAgICB2aWV3LFxuICAgICAgdGhpcy5jb25maWcudmlld3Mub3B0aW9ucy5leHRlbnNpb25cbiAgICApO1xuICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3QsIHBhdGhzLnJlbCk7XG4gICAgcmV0dXJuIHsgZmlsZVBhdGgsIHBhdGhzIH07XG4gIH1cblxuICAvLyByZXR1cm5zIHRydWUgb3IgZmFsc2UgaWYgYSB0ZW1wbGF0ZSBleGlzdHNcbiAgLy8gKHVzZXMgc2FtZSBsb29rLXVwIGFwcHJvYWNoIGFzIGByZW5kZXJgIGZ1bmN0aW9uKVxuICBhc3luYyB0ZW1wbGF0ZUV4aXN0cyh2aWV3KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZmlsZVBhdGggfSA9IGF3YWl0IHRoaXMuZ2V0VGVtcGxhdGVQYXRoKHZpZXcpO1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBzdGF0KGZpbGVQYXRoKTtcbiAgICAgIGlmICghc3RhdHMuaXNGaWxlKCkpIHRocm93IG5ldyBFcnJvcihgJHtmaWxlUGF0aH0gd2FzIG5vdCBhIGZpbGVgKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZGVidWcoJ3RlbXBsYXRlRXhpc3RzJywgZXJyKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjaGVja0FuZFJlbmRlcih0eXBlLCB0ZW1wbGF0ZSwgbG9jYWxzKSB7XG4gICAgY29uc3Qgc3RyID0gYCR7dGVtcGxhdGV9LyR7dHlwZX1gO1xuICAgIGlmICghdGhpcy5jb25maWcuY3VzdG9tUmVuZGVyKSB7XG4gICAgICBjb25zdCBleGlzdHMgPSBhd2FpdCB0aGlzLnRlbXBsYXRlRXhpc3RzKHN0cik7XG4gICAgICBpZiAoIWV4aXN0cykgcmV0dXJuO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnJlbmRlcihzdHIsIHtcbiAgICAgIC4uLmxvY2FscyxcbiAgICAgIC4uLih0eXBlID09PSAnaHRtbCcgPyB7fSA6IHsgcHJldHR5OiBmYWxzZSB9KVxuICAgIH0pO1xuICB9XG5cbiAgLy8gcHJvbWlzZSB2ZXJzaW9uIG9mIGNvbnNvbGlkYXRlJ3MgcmVuZGVyXG4gIC8vIGluc3BpcmVkIGJ5IGtvYS12aWV3cyBhbmQgcmUtdXNlcyB0aGUgc2FtZSBjb25maWdcbiAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9xdWVja2V6ei9rb2Etdmlld3M+XG4gIGFzeW5jIHJlbmRlcih2aWV3LCBsb2NhbHMgPSB7fSkge1xuICAgIGNvbnN0IHsgbWFwLCBlbmdpbmVTb3VyY2UgfSA9IHRoaXMuY29uZmlnLnZpZXdzLm9wdGlvbnM7XG4gICAgY29uc3QgeyBmaWxlUGF0aCwgcGF0aHMgfSA9IGF3YWl0IHRoaXMuZ2V0VGVtcGxhdGVQYXRoKHZpZXcpO1xuICAgIGlmIChwYXRocy5leHQgPT09ICdodG1sJyAmJiAhbWFwKSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCByZWFkRmlsZShmaWxlUGF0aCwgJ3V0ZjgnKTtcbiAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgY29uc3QgZW5naW5lTmFtZSA9IG1hcCAmJiBtYXBbcGF0aHMuZXh0XSA/IG1hcFtwYXRocy5leHRdIDogcGF0aHMuZXh0O1xuICAgIGNvbnN0IHJlbmRlckZuID0gZW5naW5lU291cmNlW2VuZ2luZU5hbWVdO1xuICAgIGlmICghZW5naW5lTmFtZSB8fCAhcmVuZGVyRm4pXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBFbmdpbmUgbm90IGZvdW5kIGZvciB0aGUgXCIuJHtwYXRocy5leHR9XCIgZmlsZSBleHRlbnNpb25gXG4gICAgICApO1xuXG4gICAgaWYgKF8uaXNPYmplY3QodGhpcy5jb25maWcuaTE4bikpIHtcbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy5jb25maWcuaTE4bi5sYXN0TG9jYWxlRmllbGQgJiZcbiAgICAgICAgdGhpcy5jb25maWcubGFzdExvY2FsZUZpZWxkICYmXG4gICAgICAgIHRoaXMuY29uZmlnLmkxOG4ubGFzdExvY2FsZUZpZWxkICE9PSB0aGlzLmNvbmZpZy5sYXN0TG9jYWxlRmllbGRcbiAgICAgIClcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUaGUgJ2xhc3RMb2NhbGVGaWVsZCcgKFN0cmluZykgb3B0aW9uIGZvciBAbGFkanMvaTE4biBhbmQgZW1haWwtdGVtcGxhdGVzIGRvIG5vdCBtYXRjaCwgaTE4biB2YWx1ZSB3YXMgJHt0aGlzLmNvbmZpZy5pMThuLmxhc3RMb2NhbGVGaWVsZH0gYW5kIGVtYWlsLXRlbXBsYXRlcyB2YWx1ZSB3YXMgJHt0aGlzLmNvbmZpZy5sYXN0TG9jYWxlRmllbGR9YFxuICAgICAgICApO1xuXG4gICAgICBjb25zdCBpMThuID0gbmV3IEkxOE4oeyAuLi50aGlzLmNvbmZpZy5pMThuLCByZWdpc3RlcjogbG9jYWxzIH0pO1xuXG4gICAgICAvLyBzdXBwb3J0IGBsb2NhbHMudXNlci5sYXN0X2xvY2FsZWAgKHZhcmlhYmxlIGJhc2VkIG5hbWUgbGFzdExvY2FsZUZpZWxkKVxuICAgICAgLy8gKGUuZy4gZm9yIDxodHRwczovL2xhZC5qcy5vcmc+KVxuICAgICAgaWYgKFxuICAgICAgICBfLmlzT2JqZWN0KGxvY2Fscy51c2VyKSAmJlxuICAgICAgICBfLmlzU3RyaW5nKGxvY2Fscy51c2VyW3RoaXMuY29uZmlnLmxhc3RMb2NhbGVGaWVsZF0pXG4gICAgICApXG4gICAgICAgIGxvY2Fscy5sb2NhbGUgPSBsb2NhbHMudXNlclt0aGlzLmNvbmZpZy5sYXN0TG9jYWxlRmllbGRdO1xuXG4gICAgICBpZiAoXy5pc1N0cmluZyhsb2NhbHMubG9jYWxlKSkgaTE4bi5zZXRMb2NhbGUobG9jYWxzLmxvY2FsZSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgcGlmeShyZW5kZXJGbikoZmlsZVBhdGgsIGxvY2Fscyk7XG4gICAgLy8gdHJhbnNmb3JtIHRoZSBodG1sIHdpdGgganVpY2UgdXNpbmcgcmVtb3RlIHBhdGhzXG4gICAgLy8gZ29vZ2xlIG5vdyBzdXBwb3J0cyBtZWRpYSBxdWVyaWVzXG4gICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vZ21haWwvZGVzaWduL3JlZmVyZW5jZS9zdXBwb3J0ZWRfY3NzXG4gICAgaWYgKCF0aGlzLmNvbmZpZy5qdWljZSkgcmV0dXJuIHJlcztcbiAgICBjb25zdCBodG1sID0gYXdhaXQgdGhpcy5qdWljZVJlc291cmNlcyhyZXMpO1xuICAgIHJldHVybiBodG1sO1xuICB9XG5cbiAgYXN5bmMgcmVuZGVyQWxsKHRlbXBsYXRlLCBsb2NhbHMgPSB7fSwgbm9kZW1haWxlck1lc3NhZ2UgPSB7fSkge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSB7IC4uLm5vZGVtYWlsZXJNZXNzYWdlIH07XG5cbiAgICBpZiAodGVtcGxhdGUpIHtcbiAgICAgIGNvbnN0IFtzdWJqZWN0LCBodG1sLCB0ZXh0XSA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBbJ3N1YmplY3QnLCAnaHRtbCcsICd0ZXh0J10ubWFwKHR5cGUgPT5cbiAgICAgICAgICB0aGlzLmNoZWNrQW5kUmVuZGVyKHR5cGUsIHRlbXBsYXRlLCBsb2NhbHMpXG4gICAgICAgIClcbiAgICAgICk7XG5cbiAgICAgIGlmIChzdWJqZWN0KSBtZXNzYWdlLnN1YmplY3QgPSBzdWJqZWN0LnRyaW0oKTtcbiAgICAgIGlmIChodG1sKSBtZXNzYWdlLmh0bWwgPSBodG1sO1xuICAgICAgaWYgKHRleHQpIG1lc3NhZ2UudGV4dCA9IHRleHQ7XG4gICAgfVxuXG4gICAgaWYgKG1lc3NhZ2Uuc3ViamVjdCAmJiB0aGlzLmNvbmZpZy5zdWJqZWN0UHJlZml4KVxuICAgICAgbWVzc2FnZS5zdWJqZWN0ID0gdGhpcy5jb25maWcuc3ViamVjdFByZWZpeCArIG1lc3NhZ2Uuc3ViamVjdDtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5odG1sVG9UZXh0ICYmIG1lc3NhZ2UuaHRtbCAmJiAhbWVzc2FnZS50ZXh0KVxuICAgICAgLy8gd2UnZCB1c2Ugbm9kZW1haWxlci1odG1sLXRvLXRleHQgcGx1Z2luXG4gICAgICAvLyBidXQgd2UgcmVhbGx5IGRvbid0IG5lZWQgdG8gc3VwcG9ydCBjaWRcbiAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vYW5kcmlzOS9ub2RlbWFpbGVyLWh0bWwtdG8tdGV4dD5cbiAgICAgIG1lc3NhZ2UudGV4dCA9IGh0bWxUb1RleHQuZnJvbVN0cmluZyhcbiAgICAgICAgbWVzc2FnZS5odG1sLFxuICAgICAgICB0aGlzLmNvbmZpZy5odG1sVG9UZXh0XG4gICAgICApO1xuXG4gICAgLy8gaWYgd2Ugb25seSB3YW50IGEgdGV4dC1iYXNlZCB2ZXJzaW9uIG9mIHRoZSBlbWFpbFxuICAgIGlmICh0aGlzLmNvbmZpZy50ZXh0T25seSkgZGVsZXRlIG1lc3NhZ2UuaHRtbDtcblxuICAgIC8vIGlmIG5vIHN1YmplY3QsIGh0bWwsIG9yIHRleHQgY29udGVudCBleGlzdHMgdGhlbiB3ZSBzaG91bGRcbiAgICAvLyB0aHJvdyBhbiBlcnJvciB0aGF0IHNheXMgYXQgbGVhc3Qgb25lIG11c3QgYmUgZm91bmRcbiAgICAvLyBvdGhlcndpc2UgdGhlIGVtYWlsIHdvdWxkIGJlIGJsYW5rIChkZWZlYXRzIHB1cnBvc2Ugb2YgZW1haWwtdGVtcGxhdGVzKVxuICAgIGlmIChcbiAgICAgICghaXMuc3RyaW5nKG1lc3NhZ2Uuc3ViamVjdCkgfHxcbiAgICAgICAgaXMuZW1wdHlTdHJpbmdPcldoaXRlc3BhY2UobWVzc2FnZS5zdWJqZWN0KSkgJiZcbiAgICAgICghaXMuc3RyaW5nKG1lc3NhZ2UudGV4dCkgfHwgaXMuZW1wdHlTdHJpbmdPcldoaXRlc3BhY2UobWVzc2FnZS50ZXh0KSkgJiZcbiAgICAgICghaXMuc3RyaW5nKG1lc3NhZ2UuaHRtbCkgfHwgaXMuZW1wdHlTdHJpbmdPcldoaXRlc3BhY2UobWVzc2FnZS5odG1sKSkgJiZcbiAgICAgIF8uaXNBcnJheShtZXNzYWdlLmF0dGFjaG1lbnRzKSAmJlxuICAgICAgXy5pc0VtcHR5KG1lc3NhZ2UuYXR0YWNobWVudHMpXG4gICAgKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gY29udGVudCB3YXMgcGFzc2VkIGZvciBzdWJqZWN0LCBodG1sLCB0ZXh0LCBub3IgYXR0YWNobWVudHMgbWVzc2FnZSBwcm9wcy4gQ2hlY2sgdGhhdCB0aGUgZmlsZXMgZm9yIHRoZSB0ZW1wbGF0ZSBcIiR7dGVtcGxhdGV9XCIgZXhpc3QuYFxuICAgICAgKTtcblxuICAgIHJldHVybiBtZXNzYWdlO1xuICB9XG5cbiAgYXN5bmMgc2VuZChvcHRpb25zID0ge30pIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgdGVtcGxhdGU6ICcnLFxuICAgICAgbWVzc2FnZToge30sXG4gICAgICBsb2NhbHM6IHt9LFxuICAgICAgLi4ub3B0aW9uc1xuICAgIH07XG5cbiAgICBsZXQgeyB0ZW1wbGF0ZSwgbWVzc2FnZSwgbG9jYWxzIH0gPSBvcHRpb25zO1xuXG4gICAgY29uc3QgYXR0YWNobWVudHMgPVxuICAgICAgbWVzc2FnZS5hdHRhY2htZW50cyB8fCB0aGlzLmNvbmZpZy5tZXNzYWdlLmF0dGFjaG1lbnRzIHx8IFtdO1xuXG4gICAgbWVzc2FnZSA9IF8uZGVmYXVsdHNEZWVwKFxuICAgICAge30sXG4gICAgICBfLm9taXQobWVzc2FnZSwgJ2F0dGFjaG1lbnRzJyksXG4gICAgICBfLm9taXQodGhpcy5jb25maWcubWVzc2FnZSwgJ2F0dGFjaG1lbnRzJylcbiAgICApO1xuICAgIGxvY2FscyA9IF8uZGVmYXVsdHNEZWVwKHt9LCB0aGlzLmNvbmZpZy52aWV3cy5sb2NhbHMsIGxvY2Fscyk7XG5cbiAgICBpZiAoYXR0YWNobWVudHMpIG1lc3NhZ2UuYXR0YWNobWVudHMgPSBhdHRhY2htZW50cztcblxuICAgIGRlYnVnKCd0ZW1wbGF0ZSAlcycsIHRlbXBsYXRlKTtcbiAgICBkZWJ1ZygnbWVzc2FnZSAlTycsIG1lc3NhZ2UpO1xuICAgIGRlYnVnKCdsb2NhbHMgKGtleXMgb25seSk6ICVPJywgT2JqZWN0LmtleXMobG9jYWxzKSk7XG5cbiAgICAvLyBnZXQgYWxsIGF2YWlsYWJsZSB0ZW1wbGF0ZXNcbiAgICBjb25zdCBvYmogPSBhd2FpdCB0aGlzLnJlbmRlckFsbCh0ZW1wbGF0ZSwgbG9jYWxzLCBtZXNzYWdlKTtcblxuICAgIC8vIGFzc2lnbiB0aGUgb2JqZWN0IHZhcmlhYmxlcyBvdmVyIHRvIHRoZSBtZXNzYWdlXG4gICAgT2JqZWN0LmFzc2lnbihtZXNzYWdlLCBvYmopO1xuXG4gICAgaWYgKHRoaXMuY29uZmlnLnByZXZpZXcpIHtcbiAgICAgIGRlYnVnKCd1c2luZyBgcHJldmlldy1lbWFpbGAgdG8gcHJldmlldyBlbWFpbCcpO1xuICAgICAgaWYgKF8uaXNPYmplY3QodGhpcy5jb25maWcucHJldmlldykpXG4gICAgICAgIGF3YWl0IHByZXZpZXdFbWFpbChtZXNzYWdlLCB0aGlzLmNvbmZpZy5wcmV2aWV3KTtcbiAgICAgIGVsc2UgYXdhaXQgcHJldmlld0VtYWlsKG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5jb25maWcuc2VuZCkge1xuICAgICAgZGVidWcoJ3NlbmQgZGlzYWJsZWQgc28gd2UgYXJlIGVuc3VyaW5nIEpTT05UcmFuc3BvcnQnKTtcbiAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbm9kZW1haWxlci9ub2RlbWFpbGVyL2lzc3Vlcy83OTg+XG4gICAgICAvLyBpZiAodGhpcy5jb25maWcudHJhbnNwb3J0Lm5hbWUgIT09ICdKU09OVHJhbnNwb3J0JylcbiAgICAgIHRoaXMuY29uZmlnLnRyYW5zcG9ydCA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHtcbiAgICAgICAganNvblRyYW5zcG9ydDogdHJ1ZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jb25maWcudHJhbnNwb3J0LnNlbmRNYWlsKG1lc3NhZ2UpO1xuICAgIGRlYnVnKCdtZXNzYWdlIHNlbnQnKTtcbiAgICByZXMub3JpZ2luYWxNZXNzYWdlID0gbWVzc2FnZTtcbiAgICByZXR1cm4gcmVzO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRW1haWw7XG4iXX0=